# API Contracts: Gitea AI Code Reviewer Webhooks

**Feature**: 001-prompts-config-refactor
**Version**: 1.0.0
**Date**: 2025-01-01

## Overview

This document defines the OpenAPI 3.0 specification for the Gitea AI Code Reviewer webhook service. The service receives push events from Gitea, fetches code diffs, sends them to an LLM for review, and posts comments as Gitea Issues.

**Base URL**: `http://gitea-ai-codereview:3008` (inside Docker network)

## Endpoints

### POST /codereview

Webhook receiver for Gitea push events. Triggers automated code review for pushed commits.

**Request**:
- Method: `POST`
- Content-Type: `application/json`
- Body: Gitea Push Event payload

**Response**:
- Content-Type: `application/json`
- Status: `200 OK`

#### Request Body (Gitea Push Event)

```json
{
  "ref": "refs/heads/main",
  "after": "6adb57c7a7b5c4e8f8b8e8f8b8e8f8b8e8f8b8e8",
  "before": "0000000000000000000000000000000000000000",
  "repository": {
    "full_name": "owner/repo",
    "name": "repo",
    "owner": {
      "username": "owner"
    }
  },
  "pusher": {
    "login": "username",
    "full_name": "Display Name",
    "email": "user@example.com"
  },
  "commits": [
    {
      "id": "6adb57c7a7b5c4e8f8b8e8f8b8e8f8b8e8f8b8e8",
      "message": "Fix bug in authentication",
      "url": "http://gitea.com/owner/repo/commit/6adb57c",
      "author": {
        "name": "Developer",
        "email": "dev@example.com"
      }
    }
  ]
}
```

#### Response 200 OK

```json
{
  "message": "Code review completed for 3 files"
}
```

#### Response 200 OK (Skipped)

```json
{
  "message": "Skip codereview"
}
```

Returned when commit title contains `[skip codereview]`.

#### Response 500 Internal Server Error

```json
{
  "message": "Error processing code review",
  "error": "Detailed error message"
}
```

### POST /test

Manual testing endpoint for code review. Accepts raw code text and returns AI review.

**Request**:
- Method: `POST`
- Content-Type: `text/plain` or `application/json`
- Body: Code to review

**Response**:
- Content-Type: `application/json`
- Status: `200 OK`

#### Request Body (Raw Text)

```
def foo():
    return "bar"
```

#### Response 200 OK

```json
{
  "message": "The function `foo()` returns a hardcoded string 'bar'. Consider making this configurable."
}
```

## Error Responses

### Common Error Codes

| Status | Description | Scenario |
|--------|-------------|----------|
| `400` | Bad Request | Invalid JSON payload |
| `500` | Internal Server Error | LLM API failure, Gitea API failure, or unexpected error |

### Error Response Schema

```json
{
  "detail": "Error message describing what went wrong"
}
```

## Examples

### Example 1: Normal Code Review Flow

**Request**:
```bash
curl -X POST http://localhost:3008/codereview \
  -H "Content-Type: application/json" \
  -d '{
    "ref": "refs/heads/main",
    "after": "abc123",
    "repository": {"full_name": "myorg/myrepo"},
    "pusher": {"login": "developer"},
    "commits": [{"message": "Add new feature", "url": "http://gitea.com/c/abc123"}]
  }'
```

**Response**:
```json
{
  "message": "Code review completed for 5 files"
}
```

### Example 2: Skip Code Review

**Request**:
```bash
curl -X POST http://localhost:3008/codereview \
  -H "Content-Type: application/json" \
  -d '{
    "ref": "refs/heads/main",
    "repository": {"full_name": "myorg/myrepo"},
    "pusher": {"login": "developer"},
    "commits": [{"message": "[skip codereview] WIP changes", "url": "http://gitea.com/c/def456"}]
  }'
```

**Response**:
```json
{
  "message": "Skip codereview"
}
```

### Example 3: Manual Test

**Request**:
```bash
curl -X POST http://localhost:3008/test \
  -H "Content-Type: text/plain" \
  -d 'def add(a, b): return a + b'
```

**Response**:
```json
{
  "message": "This is a simple addition function that adds two numbers..."
}
```

## Integration Notes

### Gitea Webhook Configuration

1. Navigate to repository Settings → Webhooks → Add Webhook → Gitea
2. Configure:
   - **Target URL**: `http://gitea-ai-codereview:3008/codereview`
   - **Content Type**: `application/json`
   - **Trigger On**: Push Events (checked)
3. Test webhook with sample payload

### Network Considerations

- **Inside Docker network**: Use container name `http://gitea-ai-codereview:3008`
- **Outside Docker network**: Use published port `http://localhost:3008` or host IP
- **Gitea integration**: Ensure `GITEA_HOST` in `.env` points to Gitea server URL

## References

- [OpenAPI Specification](https://swagger.io/specification/)
- [Gitea Webhook Documentation](https://docs.gitea.com/en-us/usage/webhooks/)
- [Feature Specification](spec.md)
